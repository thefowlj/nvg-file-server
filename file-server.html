<!DOCTYPE html>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const TABLE_ELEMENT = '#fTable';

let fileData = null;

function init() {
  let socket = io();
  socket.on('connect', () => {
    console.log(socket.id);
    $('#uploadForm').attr('action', `api/upload?clientId=${socket.id}`);
  });

  socket.on('uploadProgress', (progress) => {
    let dT = Date.now() - progress.start;
    let rate = (progress.bytesReceived / 1000000) / (dT / 1000);
    let value = (progress.bytesReceived * 100) / progress.bytesExpected;
    let rounded = Math.round(value * 10) / 10;
    let fixed = rounded.toFixed(1) + '%';
    $('#progress').attr('value', value);
    $('#pct').text(fixed);
  });

  $('#submitButton').click(() => {
    console.log('submit');
    $('body').append(`<br><progress id='progress' value='0' max='100'></progress> <span id='pct'></span>`);
  });

  $.getJSON('api/files', (data) => {
    fileData = data;
    createFileList();
  });
}

function createFileList() {
  if(fileData.files.length > 0) {
    $('body').prepend('<h1>Files</h1>')
  } else {
    $('body').prepend('<h2>No Files Available</h2>')
  }
  fileData.files.forEach((value) => {
    $(TABLE_ELEMENT).append(
      `<tr>
      <td><a href='${fileData.route}${value}'>${value}</a></td>
      <td><a href='${fileData.delete}${value}'><button type='button'>Remove</button></a></td>
      </tr>`
    );
  });
}

</script>
<body onload="init()">
  <table>
    <tbody id="fTable">
    </tbody>
  </table><br>
  <br>
  <h2>Upload</h2>
  <form id="uploadForm" action="api/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="filetoupload"><br>
    <input id="submitButton" type="submit">
  </form>
</body>
</html>
